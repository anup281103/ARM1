<div class="page-header">
 <div class="page-block">
   <h5>{{ viewMode ? 'View Material Request' : 'New Material Request' }}</h5>
  </div>
  </div>

<!-- Status Badge in View Mode -->
@if (viewMode && requestData) {
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">{{ requestData.name }}</h5>
              <p class="text-muted mb-0">Viewing Material Request Details</p>
            </div>
            <div>
              <span class="badge {{ getStatusBadgeClass(requestData.workflow_state || requestData.status) }} fs-6">
                {{ requestData.workflow_state || requestData.status }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<div class="row">
    <div class="col-md-12">
      <div class="dashboard-container">

  <!-- SESSION CARD -->
  <div class="session-card">
    <span class="status-badge">Verified</span>

    <h3 class="card-title">Session Info</h3>

    <div class="session-details">
      <div class="rowcal mb-2" *ngIf="user?.user_image">
        <img [src]="user.user_image" class="user-avatar" alt="User Avatar" onerror="this.hidden=true">
      </div>

      <div class="rowcal">
        <span class="label">User</span>
        <span class="value fw-bold">{{ user?.full_name || 'Guest' }}</span>
      </div>

      <div class="rowcal">
        <span class="label">User ID</span>
        <span class="value truncate">{{ user?.name || 'N/A' }}</span>
      </div>

      <div class="rowcal">
        <span class="label">Roles</span>
        <span class="value">
            <ng-container *ngFor="let role of user?.roles; let last = last">
                {{ role.role }}{{ !last ? ', ' : '' }}
            </ng-container>
            <span *ngIf="!user?.roles?.length">Guest</span>
        </span>
      </div>

      <div class="rowcal muted">
        <span class="label">Server Time</span>
        <span class="value">{{ serverTime | date:'yyyy-MM-dd HH:mm:ss' }}</span>
      </div>
    </div>
  </div>

  <!-- INFO CARD -->
  <div class="info-card">
    <div class="info-icon">ℹ️</div>
    <p class="info-text">
      Purchase Requisition will be created under your session and linked to your dealer account.
    </p>
  </div>

</div>


    </div>
</div>


<div class="my-4">
  <div class="card shadow-sm rounded-4 p-4">

    <!-- ROW 1 -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label text-uppercase  fw-semibold">Series</label>
        <select class="form-select">
          <option>MAT-MR-.YYYY.-</option>
        </select>
      </div>

      <div class="col-md-6">
          <label class="form-label text-uppercase  fw-semibold">Transaction Date <span class="text-danger">*</span></label>
        <input type="date" class="form-control" [(ngModel)]="requestDate" [readonly]="isReadOnly">
      </div>
    </div>

    <!-- ROW 2 -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label text-uppercase fw-semibold">Purpose</label>
        <select class="form-select" [(ngModel)]="purpose" [disabled]="isReadOnly">
          <option value="Purchase">Purchase</option>

        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label text-uppercase fw-semibold">Required By</label>
        <input type="date" class="form-control" [(ngModel)]="requiredByDate" [readonly]="isReadOnly">
      </div>
    </div>

    <!-- ROW 3 -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label text-uppercase fw-semibold">Company <span class="text-danger">*</span></label>
        <select class="form-select" [(ngModel)]="company" [disabled]="isReadOnly">
          <option *ngFor="let comp of companyList" [value]="comp.name">{{ comp.company_name }}</option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label text-uppercase fw-semibold">Price List</label>
        <select class="form-select">
          <option>Standard Buying</option>
        </select>
      </div>
    </div>

    <!-- ROW 4 - District -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label text-uppercase fw-semibold">District <span class="text-danger">*</span></label>
        <select class="form-select" [(ngModel)]="district" [disabled]="isReadOnly">
          <option *ngFor="let dist of districtList" [value]="dist.name">{{ dist.district_name || dist.name }}</option>
        </select>
      </div>
    </div>

    <!-- ITEMS HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="fw-semibold mb-0">ITEMS</h6>
      <a href="javascript:void(0)" class="text-primary small fw-semibold text-decoration-none">+ Add Item</a>
    </div>

    <!-- ITEM CARD -->
    <div class="border rounded-4 p-3 mb-4 bg-light">

      <div class="d-flex justify-content-between mb-3">
        <span class="fw-semibold ">Item 1</span>
        <a href="javascript:void(0)" class="text-danger small text-decoration-none">Remove</a>
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label ">Item Code <span class="text-danger">*</span></label>
          <input type="text" class="form-control" list="itemOptions" [(ngModel)]="itemCode" placeholder="Type or select item" [readonly]="isReadOnly">
          <datalist id="itemOptions">
            <option *ngFor="let item of itemsList" [value]="item.item_code">{{ item.item_name }}</option>
          </datalist>
        </div>

        <div class="col-md-4">
          <label class="form-label ">Quantity <span class="text-danger">*</span></label>
          <input type="number" class="form-control" [(ngModel)]="quantity" min="1" [readonly]="isReadOnly">
        </div>

        <div class="col-md-4">
          <label class="form-label ">Warehouse <span class="text-danger">*</span></label>
          <select class="form-select" [(ngModel)]="warehouse" [disabled]="isReadOnly">
             <option *ngFor="let wh of warehouseList" [value]="wh.name">{{ wh.warehouse_name }} ({{ wh.name }})</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label ">Required By</label>
          <input type="date" class="form-control" [(ngModel)]="requiredByDate">
        </div>

        <div class="col-md-4">
          <label class="form-label ">UOM</label>
          <input type="text" class="form-control" value="Nos" readonly> 
        </div>

        <div class="col-md-4">
          <label class="form-label ">Description</label>
          <input type="text" class="form-control" placeholder="Optional" [(ngModel)]="description" [readonly]="isReadOnly">
        </div>
      </div>

    </div>

    <!-- SUBMIT / BACK BUTTON -->
    <div class="text-end">
      @if (!viewMode) {
        <!-- Create Mode: Submit Request Button -->
        <button 
          class="btn btn-primary px-4 py-2 rounded-pill" 
          (click)="submit()" 
          [disabled]="!isFormValid() || submitting">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          {{ submitting ? 'Submitting...' : 'Submit Request' }}
        </button>
      } @else {
        <!-- View Mode: Show different buttons based on state -->
        <div class="d-flex gap-2 justify-content-end">
          <!-- Save Changes (Draft and Owner) -->
          @if (canEdit) {
            <button 
              class="btn btn-primary px-4 py-2 rounded-pill" 
              (click)="update()"
              [disabled]="updating">
              <span *ngIf="updating" class="spinner-border spinner-border-sm me-2"></span>
              <i class="feather icon-save"></i> {{ updating ? 'Saving...' : 'Save Changes' }}
            </button>
          }

          <!-- Submit to Collector (Draft only, owner only) -->
          @if (canSubmitToCollector) {
            <button 
              class="btn btn-success px-4 py-2 rounded-pill" 
              (click)="submitToCollector()"
              [disabled]="submittingWorkflow">
              <span *ngIf="submittingWorkflow" class="spinner-border spinner-border-sm me-2"></span>
              <i class="feather icon-send"></i> {{ submittingWorkflow ? 'Submitting...' : 'Submit to Collector' }}
            </button>
          }
          
          <!-- Create Purchase Order (Approved only, owner only) -->
          @if (canCreatePurchaseOrder) {
            <button 
              class="btn btn-primary px-4 py-2 rounded-pill" 
              (click)="createPurchaseOrder()"
              [disabled]="creatingPurchaseOrder">
              <span *ngIf="creatingPurchaseOrder" class="spinner-border spinner-border-sm me-2"></span>
              <i class="feather icon-shopping-cart"></i> {{ creatingPurchaseOrder ? 'Creating...' : 'Create Purchase Order' }}
            </button>
          }
          
          <!-- Back to List -->
          <button class="btn btn-secondary px-4 py-2 rounded-pill" (click)='goBack()'>
            <i class="feather icon-arrow-left"></i> Back to List
          </button>
          
          <!-- Collector Actions: Approve/Reject -->
          @if (canApproveOrReject) {
            <button 
              class="btn btn-success px-4 py-2 rounded-pill" 
              (click)="approveMaterialRequest()">
              <i class="feather icon-check"></i> Approve
            </button>
            <button 
              class="btn btn-danger px-4 py-2 rounded-pill" 
              (click)="rejectMaterialRequest()">
              <i class="feather icon-x"></i> Reject
            </button>
          }
        </div>
      }
    </div>

  </div>
</div>
